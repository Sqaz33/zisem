input {
  beats {
    port => 5044
  }
}

filter {

  # Основной парсер syslog
  grok {
    match => {
      "message" => [
        "%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:host} %{DATA:program}\[%{NUMBER:pid}\]: %{GREEDYDATA:msg}",
        "%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:host} %{DATA:program}: %{GREEDYDATA:msg}"  # для CRON, kernel и т.д.
      ]
    }
  }

  # SSH события
  grok {
    match => {
      "msg" => [
        "Accepted password for %{USER:user} from %{IP:src_ip} port %{NUMBER:src_port}",
        "Failed password for %{USER:user} from %{IP:src_ip} port %{NUMBER:src_port}",
        "Invalid user %{USER:user} from %{IP:src_ip} port %{NUMBER:src_port}"
      ]
    }
    tag_on_failure => []
  }

  # Firewall события
  grok {
    match => {
      "msg" => [
        "Firewall: \*(?<firewall_action>[A-Z_]+)\* IN=%{DATA:in_iface} OUT=%{DATA:out_iface} MAC=%{DATA:mac} SRC=%{IP:src_ip} DST=%{IP:dst_ip} LEN=%{NUMBER:len} TOS=%{DATA:tos}"
      ]
    }
    tag_on_failure => []
  }

  # Sudo события
  grok {
    match => {
      "msg" => [
        "%{USER:sudo_user} : TTY=%{DATA:tty} ; PWD=%{DATA:pwd} ; USER=%{USER:run_as_user} ; COMMAND=%{GREEDYDATA:command}"
      ]
    }
    tag_on_failure => []
  }

  # Категоризация событий для ИБ
  if "Accepted password" in [msg] {
    mutate { add_field => { "event_type" => "ssh_login_success" } }
  } else if "Failed password" in [msg] or "Invalid user" in [msg] {
    mutate { add_field => { "event_type" => "ssh_login_failed" } }
  } else if "Firewall" in [msg] {
    mutate { add_field => { "event_type" => "firewall_block" } }
  } else if "sudo" in [program] or "COMMAND=" in [msg] {
    mutate { add_field => { "event_type" => "sudo_command" } }
  } else if "CRON" in [program] {
    mutate { add_field => { "event_type" => "cron_job" } }
  } else {
    mutate { add_field => { "event_type" => "system_event" } }
  }

  # Нормализация времени
  date {
    match => ["timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss"]
    timezone => "UTC"
  }

  mutate {
    remove_field => ["agent", "ecs", "input", "log", "host"]
  }
}

output {
  opensearch {
    hosts => ["http://opensearch:9200"]
    index => "linux-auth-logs-%{+YYYY.MM.dd}"
    user => "admin"
    password => "YourStrongPassword1!"
    ssl => false
  }
}
