input {
  beats {
    port => 5044
  }
}

filter {
  grok {
    match => {
      "message" => [
        "%{TIMESTAMP_ISO8601:log_timestamp} %{HOSTNAME:host_name} %{WORD:log_source} %{INT:event_id} %{DATA:event_message}\."
      ]
    }
  }

  date {
    match => ["log_timestamp", "yyyy-MM-dd HH:mm:ss"]
    target => "@timestamp"
  }

  grok {
    match => {
      "message" => [
        "Failure Information:\s+Status:\s+%{BASE16NUM:errlogon.failure_status}\s+Sub Status:\s+%{BASE16NUM:errlogon.failure_sub_status}"
      ]
    }
    tag_on_failure => []
  }

  grok {
    match => {
      "message" => [
        "Network Information:\s+Workstation Name:\s+%{DATA:workstation}\s+Source Network Address:\s+%{IP:source.ip}\s+Source Port:\s+%{INT:source.port}"
      ]
    }
    tag_on_failure => []
  }

  if [event_id] == "4624" {
    mutate {
      add_field => {
        "event_type"   => "login"
        "event_action" => "success"
        "event_result" => "success"
        "severity"     => "normal"
        "severity_color" => "green"
      }
    }
  }

  else if [event_id] == "4625" {
    mutate {
      add_field => {
        "event_type"   => "login"
        "event_action" => "failure"
        "event_result" => "failure"
        "severity"     => "warning"
        "severity_color" => "yellow"
      }
    }

    translate {
      field       => "errlogon.failure_status"
      destination => "errlogon.reason"
      dictionary  => {
        "0xC000006A" => "Bad password"
        "0xC0000064" => "User does not exist"
        "0xC000006D" => "Bad username or password"
        "0xC0000070" => "Account logon time restriction violation"
        "0xC0000071" => "Expired password"
        "0xC0000072" => "Account disabled"
        "0xC0000133" => "Clock skew too great"
        "0xC0000193" => "Account expired"
        "0xC0000224" => "Password must change"
        "0xC0000234" => "Account locked out"
      }
      fallback => "Unknown failure status"
    }
  }

  else if [event_id] == "4672" {
    mutate {
      add_field => {
        "event_type"   => "privilege"
        "event_action" => "assigned"
        "event_result" => "success"
        "severity"     => "critical"
        "severity_color" => "red"
      }
    }
  }

  else if [event_id] == "4723" {
    mutate {
      add_field => {
        "event_type"   => "password_change"
        "event_action" => "attempt"
        "event_result" => "failure"
        "severity"     => "warning"
        "severity_color" => "yellow"
      }
    }
  }

  else if [event_id] == "4688" {
    mutate {
      add_field => {
        "event_type"     => "process"
        "event_action"   => "create"
        "event_result"   => "success"
        "severity"       => "info"
        "severity_color" => "blue"
      }
    }
  }

  else if [event_id] == "4720" {
    mutate {
      add_field => {
        "event_type"     => "account"
        "event_action"   => "create"
        "event_result"   => "success"
        "severity"       => "critical"
        "severity_color" => "red"
      }
    }
  }

  else {
    mutate {
      add_field => {
        "event_type" => "other"
        "severity"  => "neutral"
        "severity_color" => "blue"
      }
    }
  }

  if [event_action] == "failure" {
    mutate {
      add_field => {
        "failed_login" => "true"
      }
    }
  }

  if [event_type] == "privilege" {
    mutate {
      add_field => {
        "security_incident" => "true"
      }
    }
  }

  mutate {
    convert => {
      "src_port"  => "integer"
      "logon_type" => "integer"
    }
  }

  geoip {
    source => "source.ip"
    target => "source"
    database => "/usr/share/logstash/GeoLite2-City.mmdb"
    tag_on_failure => []
  }
}

output {
  opensearch {
    hosts => ["http://opensearch:9200"]
    index => "windows-security-%{+YYYY.MM.dd}"
    user => "admin"
    password => "YourStrongPassword1!"
    ssl => false
  }
}
